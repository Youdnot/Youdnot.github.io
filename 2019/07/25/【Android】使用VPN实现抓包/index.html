<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>【android】 使用vpn实现抓包 | iTimeTraveler</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="VPN" />
  
  
  
  
  <meta name="description" content="VPN抓包使用VPN技术可以直接获得网络三层IP报文，可以不可以基于此实现移动端抓包呢？肯定可以，Android已经有大批开源库基于该思路实现抓包。我们来学习下原理。 VpnServiceVpnService是开发Android VPN的基础，下面是官方文档的阐释  VpnService is a base class for applications to extend and build th">
<meta name="keywords" content="VPN">
<meta property="og:type" content="article">
<meta property="og:title" content="【Android】 使用VPN实现抓包">
<meta property="og:url" content="https://itimetraveler.github.io/2019/07/25/【Android】使用VPN实现抓包/index.html">
<meta property="og:site_name" content="iTimeTraveler">
<meta property="og:description" content="VPN抓包使用VPN技术可以直接获得网络三层IP报文，可以不可以基于此实现移动端抓包呢？肯定可以，Android已经有大批开源库基于该思路实现抓包。我们来学习下原理。 VpnServiceVpnService是开发Android VPN的基础，下面是官方文档的阐释  VpnService is a base class for applications to extend and build th">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://itimetraveler.github.io/gallery/android_common/VPN-Tunnel.png">
<meta property="og:updated_time" content="2019-12-13T09:54:12.826Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="【Android】 使用VPN实现抓包">
<meta name="twitter:description" content="VPN抓包使用VPN技术可以直接获得网络三层IP报文，可以不可以基于此实现移动端抓包呢？肯定可以，Android已经有大批开源库基于该思路实现抓包。我们来学习下原理。 VpnServiceVpnService是开发Android VPN的基础，下面是官方文档的阐释  VpnService is a base class for applications to extend and build th">
<meta name="twitter:image" content="https://itimetraveler.github.io/gallery/android_common/VPN-Tunnel.png">
  
    <link rel="alternate" href="/atom.xml" title="iTimeTraveler" type="application/atom+xml">
  

  

  <link rel="icon" href="/gallery/avatar/0.jpg">
  <link rel="apple-touch-icon" href="/gallery/avatar/0.jpg">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt; src:url("css/fonts/FuturaPTBold.otf") format("woff");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt-light; src:url("css/fonts/FuturaPTBook.otf") format("woff");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt-italic; src:url("css/fonts/FuturaPTBookOblique.otf") format("woff");font-weight:400;font-style:italic;}
}

  </style>
  <link rel="stylesheet" href="../../../../css/style.css">

  <script src="../../../../js/jquery-3.1.1.min.js"></script>
  <script src="../../../../js/bootstrap.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >

  
    <link rel="stylesheet" href="../../../../css/dialog.css">
  

  

  
    <link rel="stylesheet" href="/css/header-post.css" >
  

  
  
  
    <link rel="stylesheet" href="/css/vdonate.css" >
  

</head>



  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  <div id="container">
    <div id="wrap">
      
        <header>

    <div id="allheader" class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="navbar-inner">
          
          <div class="container"> 
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>

            
              <a class="brand" style="
                 border-width: 0px;  margin-top: 8px;"  
                href="#" data-toggle="modal" data-target="#myModal" >
                  <img width="62px" height="75px" alt="Hike News" src="/gallery/avatar/0.jpg">
              </a>
            
            
            <div class="navbar-collapse collapse">
              <ul class="hnav navbar-nav">
                
                  <li> <a class="main-nav-link" href="../../../../index.html">首页</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../archives">归档</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../categories">分类</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../tags">标签</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../funnysite">酷站</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../collection">收藏</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../about">关于</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../mybooks">🎁</a> </li>
                
                  <li><div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="请输入关键词..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(无标题)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '../../../../content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="../../../../js/insight.js"></script>

</div></li>
            </div>
          </div>
                
      </div>
    </div>

</header>



      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-【Android】使用VPN实现抓包" style="width: 75%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" href="../../../../gallery/android_common/VPN-Tunnel.png" rel="gallery_ck445is8z006jkis6rn46fms1">
        <img src="../../../../gallery/android_common/VPN-Tunnel.png" itemprop="image">
      </a>
    
  </div>
</div>

    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      【Android】 使用VPN实现抓包
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="" class="article-date">
	  <time datetime="2019-07-25T14:20:55.000Z" itemprop="datePublished">2019-07-25</time>
	</a>

      
    <a class="article-category-link" href="../../../../categories/Android/">Android</a>

      
	<a class="article-views">
	<span id="busuanzi_container_page_pv">
		阅读量<span id="busuanzi_value_page_pv"></span>
	</span>
	</a>

      

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="VPN抓包"><a href="#VPN抓包" class="headerlink" title="VPN抓包"></a>VPN抓包</h2><p>使用VPN技术可以直接获得网络三层IP报文，可以不可以基于此实现移动端抓包呢？肯定可以，Android已经有大批开源库基于该思路实现抓包。我们来学习下原理。</p>
<h2 id="VpnService"><a href="#VpnService" class="headerlink" title="VpnService"></a>VpnService</h2><p>VpnService是开发Android VPN的基础，下面是<a href="https://developer.android.com/reference/android/net/VpnService" target="_blank" rel="noopener">官方文档</a>的阐释</p>
<blockquote>
<p>VpnService is a base class for applications to extend and build their own VPN solutions. In general, it creates a virtual network interface, configures addresses and routing rules, and returns a file descriptor to the application. Each read from the descriptor retrieves an outgoing packet which was routed to the interface. Each write to the descriptor injects an incoming packet just like it was received from the interface. The interface is running on Internet Protocol (IP), so packets are always started with IP headers. The application then completes a VPN connection by processing and exchanging packets with the remote server over a tunnel.</p>
</blockquote>
<p>上面的阐释的重点是：</p>
<ul>
<li>虚拟一个网卡</li>
<li>返回文件描述符</li>
<li>读写的内容是ip数据报</li>
</ul>
<p>首先推荐Android官方提供了的Example：<a href="https://android.googlesource.com/platform/development/+/master/samples/ToyVpn" target="_blank" rel="noopener">ToyVpn</a>。这个例子比较简单，实操一遍可以帮助理解VPN原理。</p>
<p>初步搭一个vpn应用框架也可以参考<a href="https://www.tuicool.com/articles/uuiMje" target="_blank" rel="noopener">这篇文章</a>，这个仅仅是搭建了框架，功能（ip数据包的收发）则没有实现。</p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>Android系统提供的API是VpnService，我们调用<code>establish()</code>方法之后会返回一个FD。然后我们读取该FD就能获得ip数据报文，通过发往VPN Server，再获得Server的回复报文之后再写入该FD，就可以实现VPN通信。</p>
<h3 id="VpnService-establish"><a href="#VpnService-establish" class="headerlink" title="VpnService#establish()"></a>VpnService#establish()</h3><p>[-&gt; frameworks/base/core/java/android/net/VpnService.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Create a VPN interface using the parameters supplied to this</span></span><br><span class="line"><span class="comment">* builder. The interface works on IP packets, and a file descriptor</span></span><br><span class="line"><span class="comment">* is returned for the application to access them. Each read</span></span><br><span class="line"><span class="comment">* retrieves an outgoing packet which was routed to the interface.</span></span><br><span class="line"><span class="comment">* Each write injects an incoming packet just like it was received</span></span><br><span class="line"><span class="comment">* from the interface. The file descriptor is put into non-blocking</span></span><br><span class="line"><span class="comment">* mode by default to avoid blocking Java threads. To use the file</span></span><br><span class="line"><span class="comment">* descriptor completely in native space, see</span></span><br><span class="line"><span class="comment">* &#123;<span class="doctag">@link</span> ParcelFileDescriptor#detachFd()&#125;. The application MUST</span></span><br><span class="line"><span class="comment">* close the file descriptor when the VPN connection is terminated.</span></span><br><span class="line"><span class="comment">* The VPN interface will be removed and the network will be</span></span><br><span class="line"><span class="comment">* restored by the system automatically.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* &lt;p&gt;To avoid conflicts, there can be only one active VPN interface</span></span><br><span class="line"><span class="comment">* at the same time. Usually network parameters are never changed</span></span><br><span class="line"><span class="comment">* during the lifetime of a VPN connection. It is also common for an</span></span><br><span class="line"><span class="comment">* application to create a new file descriptor after closing the</span></span><br><span class="line"><span class="comment">* previous one. However, it is rare but not impossible to have two</span></span><br><span class="line"><span class="comment">* interfaces while performing a seamless handover. In this case, the</span></span><br><span class="line"><span class="comment">* old interface will be deactivated when the new one is created</span></span><br><span class="line"><span class="comment">* successfully. Both file descriptors are valid but now outgoing</span></span><br><span class="line"><span class="comment">* packets will be routed to the new interface. Therefore, after</span></span><br><span class="line"><span class="comment">* draining the old file descriptor, the application MUST close it</span></span><br><span class="line"><span class="comment">* and start using the new file descriptor. If the new interface</span></span><br><span class="line"><span class="comment">* cannot be created, the existing interface and its file descriptor</span></span><br><span class="line"><span class="comment">* remain untouched.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* &lt;p&gt;An exception will be thrown if the interface cannot be created</span></span><br><span class="line"><span class="comment">* for any reason. However, this method returns &#123;<span class="doctag">@code</span> null&#125; if the</span></span><br><span class="line"><span class="comment">* application is not prepared or is revoked. This helps solve</span></span><br><span class="line"><span class="comment">* possible race conditions between other VPN applications.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> &#123;<span class="doctag">@link</span> ParcelFileDescriptor&#125; of the VPN interface, or</span></span><br><span class="line"><span class="comment">*         &#123;<span class="doctag">@code</span> null&#125; if the application is not prepared.</span></span><br><span class="line"><span class="comment">* <span class="doctag">@throws</span> IllegalArgumentException if a parameter is not accepted</span></span><br><span class="line"><span class="comment">*         by the operating system.</span></span><br><span class="line"><span class="comment">* <span class="doctag">@throws</span> IllegalStateException if a parameter cannot be applied</span></span><br><span class="line"><span class="comment">*         by the operating system.</span></span><br><span class="line"><span class="comment">* <span class="doctag">@throws</span> SecurityException if the service is not properly declared</span></span><br><span class="line"><span class="comment">*         in &#123;<span class="doctag">@code</span> AndroidManifest.xml&#125;.</span></span><br><span class="line"><span class="comment">* <span class="doctag">@see</span> VpnService</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ParcelFileDescriptor <span class="title">establish</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   mConfig.addresses = mAddresses;</span><br><span class="line">   mConfig.routes = mRoutes;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> getService().establishVpn(mConfig);</span><br><span class="line">   &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Use IConnectivityManager since those methods are hidden and not</span></span><br><span class="line"><span class="comment">* available in ConnectivityManager.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> IConnectivityManager <span class="title">getService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> IConnectivityManager.Stub.asInterface(</span><br><span class="line">          ServiceManager.getService(Context.CONNECTIVITY_SERVICE));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实是调用了ConnectivityService 这个系统服务的 <code>establishVpn(mConfig)</code>方法。</p>
<h3 id="ConnectivityService-establishVpn"><a href="#ConnectivityService-establishVpn" class="headerlink" title="ConnectivityService#establishVpn()"></a>ConnectivityService#establishVpn()</h3><p>[-&gt; frameworks/base/services/core/java/com/android/server/ConnectivityService.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> SparseArray&lt;Vpn&gt; mVpns = <span class="keyword">new</span> SparseArray&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Configure a TUN interface and return its file descriptor. Parameters</span></span><br><span class="line"><span class="comment">  * are encoded and opaque to this class. This method is used by VpnBuilder</span></span><br><span class="line"><span class="comment">  * and not available in ConnectivityManager. Permissions are checked in</span></span><br><span class="line"><span class="comment">  * Vpn class.</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> ParcelFileDescriptor <span class="title">establishVpn</span><span class="params">(VpnConfig config)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">int</span> user = UserHandle.getUserId(Binder.getCallingUid());</span><br><span class="line">     <span class="keyword">synchronized</span> (mVpns) &#123;</span><br><span class="line">         throwIfLockdownEnabled();</span><br><span class="line">         <span class="comment">// mVpns其实是个Vpn数组</span></span><br><span class="line">         <span class="keyword">return</span> mVpns.get(user).establish(config);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Vpn-establish"><a href="#Vpn-establish" class="headerlink" title="Vpn#establish()"></a>Vpn#establish()</h3><p>[-&gt; frameworks/base/services/core/java/com/android/server/connectivity/Vpn.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Establish a VPN network and return the file descriptor of the VPN interface. This methods</span></span><br><span class="line"><span class="comment"> * returns &#123;<span class="doctag">@code</span> null&#125; if the application is revoked or not prepared.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> config The parameters to configure the network.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> The file descriptor of the VPN interface.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> ParcelFileDescriptor <span class="title">establish</span><span class="params">(VpnConfig config)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Check if the caller is already prepared.</span></span><br><span class="line">    UserManager mgr = UserManager.get(mContext);</span><br><span class="line">    <span class="keyword">if</span> (Binder.getCallingUid() != mOwnerUID) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Check to ensure consent hasn't been revoked since we were prepared.</span></span><br><span class="line">    <span class="keyword">if</span> (!isVpnUserPreConsented(mPackage)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Check if the service is properly declared.</span></span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent(VpnConfig.SERVICE_INTERFACE);</span><br><span class="line">    intent.setClassName(mPackage, config.user);</span><br><span class="line">    <span class="keyword">long</span> token = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Restricted users are not allowed to create VPNs, they are tied to Owner</span></span><br><span class="line">        UserInfo user = mgr.getUserInfo(mUserHandle);</span><br><span class="line">        <span class="keyword">if</span> (user.isRestricted()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Restricted users cannot establish VPNs"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ResolveInfo info = AppGlobals.getPackageManager().resolveService(intent,</span><br><span class="line">                <span class="keyword">null</span>, <span class="number">0</span>, mUserHandle);</span><br><span class="line">        <span class="keyword">if</span> (info == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Cannot find "</span> + config.user);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!BIND_VPN_SERVICE.equals(info.serviceInfo.permission)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(config.user + <span class="string">" does not require "</span> + BIND_VPN_SERVICE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Cannot find "</span> + config.user);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(token);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Save the old config in case we need to go back.</span></span><br><span class="line">    VpnConfig oldConfig = mConfig;</span><br><span class="line">    String oldInterface = mInterface;</span><br><span class="line">    Connection oldConnection = mConnection;</span><br><span class="line">    NetworkAgent oldNetworkAgent = mNetworkAgent;</span><br><span class="line">    Set&lt;UidRange&gt; oldUsers = mNetworkCapabilities.getUids();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用jniCreate方法创建了一个FD</span></span><br><span class="line">    <span class="comment">// Configure the interface. Abort if any of these steps fails.</span></span><br><span class="line">    ParcelFileDescriptor tun = ParcelFileDescriptor.adoptFd(jniCreate(config.mtu));</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String interfaze = jniGetName(tun.getFd());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TEMP use the old jni calls until there is support for netd address setting</span></span><br><span class="line">        StringBuilder builder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (LinkAddress address : config.addresses) &#123;</span><br><span class="line">            builder.append(<span class="string">" "</span>);</span><br><span class="line">            builder.append(address);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (jniSetAddresses(interfaze, builder.toString()) &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"At least one address must be specified"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Connection connection = <span class="keyword">new</span> Connection();</span><br><span class="line">        <span class="keyword">if</span> (!mContext.bindServiceAsUser(intent, connection,</span><br><span class="line">                Context.BIND_AUTO_CREATE | Context.BIND_FOREGROUND_SERVICE,</span><br><span class="line">                <span class="keyword">new</span> UserHandle(mUserHandle))) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot bind "</span> + config.user);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mConnection = connection;</span><br><span class="line">        mInterface = interfaze;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Fill more values.</span></span><br><span class="line">        config.user = mPackage;</span><br><span class="line">        config.interfaze = mInterface;</span><br><span class="line">        config.startTime = SystemClock.elapsedRealtime();</span><br><span class="line">        mConfig = config;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set up forwarding and DNS rules.</span></span><br><span class="line">        <span class="comment">// First attempt to do a seamless handover that only changes the interface name and</span></span><br><span class="line">        <span class="comment">// parameters. If that fails, disconnect.</span></span><br><span class="line">        <span class="keyword">if</span> (oldConfig != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; updateLinkPropertiesInPlaceIfPossible(mNetworkAgent, oldConfig)) &#123;</span><br><span class="line">            <span class="comment">// Keep mNetworkAgent unchanged</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mNetworkAgent = <span class="keyword">null</span>;</span><br><span class="line">            updateState(DetailedState.CONNECTING, <span class="string">"establish"</span>);</span><br><span class="line">            <span class="comment">// Set up forwarding and DNS rules.</span></span><br><span class="line">            agentConnect();</span><br><span class="line">            <span class="comment">// Remove the old tun's user forwarding rules</span></span><br><span class="line">            <span class="comment">// The new tun's user rules have already been added above so they will take over</span></span><br><span class="line">            <span class="comment">// as rules are deleted. This prevents data leakage as the rules are moved over.</span></span><br><span class="line">            agentDisconnect(oldNetworkAgent);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (oldConnection != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mContext.unbindService(oldConnection);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (oldInterface != <span class="keyword">null</span> &amp;&amp; !oldInterface.equals(interfaze)) &#123;</span><br><span class="line">            jniReset(oldInterface);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            IoUtils.setBlocking(tun.getFileDescriptor(), config.blocking);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                    <span class="string">"Cannot set tunnel's fd as blocking="</span> + config.blocking, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        IoUtils.closeQuietly(tun);</span><br><span class="line">        <span class="comment">// If this is not seamless handover, disconnect partially-established network when error</span></span><br><span class="line">        <span class="comment">// occurs.</span></span><br><span class="line">        <span class="keyword">if</span> (oldNetworkAgent != mNetworkAgent) &#123;</span><br><span class="line">            agentDisconnect();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// restore old state</span></span><br><span class="line">        mConfig = oldConfig;</span><br><span class="line">        mConnection = oldConnection;</span><br><span class="line">        mNetworkCapabilities.setUids(oldUsers);</span><br><span class="line">        mNetworkAgent = oldNetworkAgent;</span><br><span class="line">        mInterface = oldInterface;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">    Log.i(TAG, <span class="string">"Established by "</span> + config.user + <span class="string">" on "</span> + mInterface);</span><br><span class="line">    <span class="keyword">return</span> tun;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>establish()</code>方法除了权限校验之外，主要是通过<code>jniCreate</code>方法创建了一个FD并返回，这个FD其实就是tun设备。而此处的<code>jniCreate</code>方法是native方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">jniCreate</span><span class="params">(<span class="keyword">int</span> mtu)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> String <span class="title">jniGetName</span><span class="params">(<span class="keyword">int</span> tun)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">jniSetAddresses</span><span class="params">(String interfaze, String addresses)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">jniReset</span><span class="params">(String interfaze)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">jniCheck</span><span class="params">(String interfaze)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">jniAddAddress</span><span class="params">(String interfaze, String address, <span class="keyword">int</span> prefixLen)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">jniDelAddress</span><span class="params">(String interfaze, String address, <span class="keyword">int</span> prefixLen)</span></span>;</span><br></pre></td></tr></table></figure>
<p>可以看到一系列的native方法，这些方法都位于<code>com_android_server_connectivity_Vpn.cpp</code>中：</p>
<h3 id="jniCreate"><a href="#jniCreate" class="headerlink" title="jniCreate()"></a>jniCreate()</h3><p>[-&gt; frameworks/base/services/core/jni/com_android_server_connectivity_Vpn.cpp]</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> JNINativeMethod gMethods[] = &#123;</span><br><span class="line">    &#123;<span class="string">"jniCreate"</span>, <span class="string">"(I)I"</span>, (<span class="keyword">void</span> *)create&#125;,</span><br><span class="line">    &#123;<span class="string">"jniGetName"</span>, <span class="string">"(I)Ljava/lang/String;"</span>, (<span class="keyword">void</span> *)getName&#125;,</span><br><span class="line">    &#123;<span class="string">"jniSetAddresses"</span>, <span class="string">"(Ljava/lang/String;Ljava/lang/String;)I"</span>, (<span class="keyword">void</span> *)setAddresses&#125;,</span><br><span class="line">    &#123;<span class="string">"jniReset"</span>, <span class="string">"(Ljava/lang/String;)V"</span>, (<span class="keyword">void</span> *)reset&#125;,</span><br><span class="line">    &#123;<span class="string">"jniCheck"</span>, <span class="string">"(Ljava/lang/String;)I"</span>, (<span class="keyword">void</span> *)check&#125;,</span><br><span class="line">    &#123;<span class="string">"jniAddAddress"</span>, <span class="string">"(Ljava/lang/String;Ljava/lang/String;I)Z"</span>, (<span class="keyword">void</span> *)addAddress&#125;,</span><br><span class="line">    &#123;<span class="string">"jniDelAddress"</span>, <span class="string">"(Ljava/lang/String;Ljava/lang/String;I)Z"</span>, (<span class="keyword">void</span> *)delAddress&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建tun设备</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> jint <span class="title">create</span><span class="params">(JNIEnv *env, jobject <span class="comment">/* thiz */</span>, jint mtu)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> tun = create_interface(mtu);</span><br><span class="line">    <span class="keyword">if</span> (tun &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        throwException(env, tun, <span class="string">"Cannot create interface"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tun;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">create_interface</span><span class="params">(<span class="keyword">int</span> mtu)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> tun = open(<span class="string">"/dev/tun"</span>, O_RDWR | O_NONBLOCK | O_CLOEXEC);</span><br><span class="line"></span><br><span class="line">    ifreq ifr4;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;ifr4, <span class="number">0</span>, <span class="keyword">sizeof</span>(ifr4));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allocate interface.</span></span><br><span class="line">    ifr4.ifr_flags = IFF_TUN | IFF_NO_PI;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(tun, TUNSETIFF, &amp;ifr4)) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Cannot allocate TUN: %s"</span>, strerror(errno));</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Activate interface.</span></span><br><span class="line">    ifr4.ifr_flags = IFF_UP;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(inet4, SIOCSIFFLAGS, &amp;ifr4)) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Cannot activate %s: %s"</span>, ifr4.ifr_name, strerror(errno));</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set MTU if it is specified.</span></span><br><span class="line">    ifr4.ifr_mtu = mtu;</span><br><span class="line">    <span class="keyword">if</span> (mtu &gt; <span class="number">0</span> &amp;&amp; ioctl(inet4, SIOCSIFMTU, &amp;ifr4)) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Cannot set MTU on %s: %s"</span>, ifr4.ifr_name, strerror(errno));</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tun;</span><br><span class="line"></span><br><span class="line">error:</span><br><span class="line">    close(tun);</span><br><span class="line">    <span class="keyword">return</span> SYSTEM_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就很明显能看到最终调用的是<code>create_interface</code>方法，该方法其实就是打开<code>/dev/tun</code>文件，然后设置一下MTU并返回这个FD。</p>
<p><code>/dev/tun</code>文件就是Linux中的TUN设备。</p>
<h2 id="TUN-TAP是什么"><a href="#TUN-TAP是什么" class="headerlink" title="TUN/TAP是什么"></a>TUN/TAP是什么</h2><p>tap/tun 是 Linux 内核 2.4.x 版本之后实现的虚拟网络设备，不同于物理网卡，tap/tun 虚拟网卡完全由软件来实现，功能和硬件实现完全没有差别，它们都属于网络设备，都可以配置 IP，都归 Linux 网络设备管理模块统一管理。<br><strong>TAP</strong> 设备与 <strong>TUN</strong> 设备都是虚拟网络设备，工作方式完全相同，但它们的工作层次不太一样：</p>
<ul>
<li>tap 是一个二层设备（或者以太网设备），只能处理二层的以太网帧；</li>
<li>tun 是一个点对点的三层设备（或网络层设备），只能处理三层的 IP 数据包。</li>
</ul>
<p>作为网络设备，tap/tun 也需要配套相应的驱动程序才能工作。tap/tun 驱动程序包括两个部分，一个是字符设备驱动，一个是网卡驱动。这两部分驱动程序分工不太一样，字符驱动负责数据包在内核空间和用户空间的传送，网卡驱动负责数据包在 TCP/IP 网络协议栈上的传输和处理。</p>
<h3 id="字符驱动-内核空间和用户空间的数据传输"><a href="#字符驱动-内核空间和用户空间的数据传输" class="headerlink" title="字符驱动 - 内核空间和用户空间的数据传输"></a>字符驱动 - 内核空间和用户空间的数据传输</h3><p>在 Linux 中，用户空间和内核空间的数据传输有多种方式，字符设备就是其中的一种。tap/tun 通过驱动程序和一个与之关联的字符设备，来实现用户空间和内核空间的通信接口。</p>
<p>在 Linux 内核 2.6.x 之后的版本中，tap/tun 对应的字符设备文件分别为：</p>
<ul>
<li>tap：/dev/tap0</li>
<li>tun：/dev/tun0</li>
</ul>
<p>设备文件即充当了用户空间和内核空间通信的接口。当应用程序打开设备文件时，驱动程序就会创建并注册相应的虚拟设备接口，一般以 <code>tunX</code> 或 <code>tapX</code> 命名。当应用程序关闭文件时，驱动也会自动删除 <code>tunX</code> 和 <code>tapX</code> 设备，还会删除已经建立起来的路由等信息。</p>
<p>tap/tun 设备文件就像一个管道，一端连接着用户空间，一端连接着内核空间。当用户程序向文件 <code>/dev/net/tun</code> 或 <code>/dev/tap0</code> 写数据时，内核就可以从对应的 <code>tunX</code> 或 <code>tapX</code> 接口读到数据，反之，内核可以通过相反的方式向用户程序发送数据。</p>
<h3 id="网卡驱动-数据包在-TCP-IP-协议栈的传输"><a href="#网卡驱动-数据包在-TCP-IP-协议栈的传输" class="headerlink" title="网卡驱动 - 数据包在 TCP/IP 协议栈的传输"></a>网卡驱动 - 数据包在 TCP/IP 协议栈的传输</h3><p>参考<a href="https://blog.kghost.info/2013/03/27/linux-network-tun/" target="_blank" rel="noopener">网络虚拟化技术（二）: TUN/TAP MACVLAN MACVTAP</a>，先来看看物理网卡是如何工作的：</p>
<p><img src="/gallery/android_common/tunortap-eth0.png" alt="真实网卡的工作机制"></p>
<p>普通网卡通过网线收发数据包，所有物理网卡收到的包会交给内核的 Network Stack 处理，然后通过 Socket API 通知给用户程序。</p>
<p>但是 TUN 设备通过一个<code>/dev/tunX</code>文件收发数据包。所有对该文件的写操作会通过 TUN 设备转换成一个数据包送给内核；当内核发送一个包给 TUN 设备时，通过读这个文件可以拿到包的内容。</p>
<p>如果我们使用 TUN 设备搭建一个基于 UDP VPN，那么整个处理过程就是这样：</p>
<p><img src="/gallery/android_common/tunortap-tun.png" alt="基于 UDP 的 VPN 工作机制"></p>
<p>数据包会通过内核网络栈两次。但是经过 App 的处理后，数据包可能已经加密，并且原有的 ip 头被封装在 udp 内部，所以第二次通过网络栈内核看到的添加了新的IP头和UDP头的数据包。</p>
<p><img src="/gallery/android_common/090751088583813.jpg" alt="第二次进入网络栈内核后的IP数据包变化"></p>
<p>tap/tun 通过实现相应的网卡驱动程序来和网络协议栈通信。一般的流程和物理网卡和协议栈的交互流程是一样的，不同的是物理网卡一端是连接物理网络，而 tap/tun 虚拟网卡一般连接到用户空间。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">+----------------------------------------------------------------+</span><br><span class="line">|                                                                |</span><br><span class="line">|  +--------------------+      +--------------------+            |</span><br><span class="line">|  | User Application A |      | User Application B |&lt;-----+     |</span><br><span class="line">|  +--------------------+      +--------------------+      |     |</span><br><span class="line">|               | <span class="number">1</span>                    | <span class="number">5</span>                 |     |</span><br><span class="line">|...............|......................|...................|.....|</span><br><span class="line">|               ↓                      ↓                   |     |</span><br><span class="line">|         +----------+           +----------+              |     |</span><br><span class="line">|         | socket A |           | socket B |              |     |</span><br><span class="line">|         +----------+           +----------+              |     |</span><br><span class="line">|                 | <span class="number">2</span>               | <span class="number">6</span>                    |     |</span><br><span class="line">|.................|.................|......................|.....|</span><br><span class="line">|                 ↓                 ↓                      |     |</span><br><span class="line">|             +------------------------+                 <span class="number">4</span> |     |</span><br><span class="line">|             | Newwork Protocol Stack |                   |     |</span><br><span class="line">|             +------------------------+                   |     |</span><br><span class="line">|                | <span class="number">7</span>                 | <span class="number">3</span>                   |     |</span><br><span class="line">|................|...................|.....................|.....|</span><br><span class="line">|                ↓                   ↓                     |     |</span><br><span class="line">|        +----------------+    +----------------+          |     |</span><br><span class="line">|        |      eth0      |    |      tun0      |          |     |</span><br><span class="line">|        +----------------+    +----------------+          |     |</span><br><span class="line">|    <span class="number">10.32</span>.0.11  |                   |   <span class="number">192.168</span>.3.11      |     |</span><br><span class="line">|                | <span class="number">8</span>                 +---------------------+     |</span><br><span class="line">|                |                                               |</span><br><span class="line">+----------------|-----------------------------------------------+</span><br><span class="line">                 ↓</span><br><span class="line">         Physical Network</span><br></pre></td></tr></table></figure>
<p>上图中有两个应用程序A和B，都在用户层，而其它的socket、协议栈（Newwork Protocol Stack）和网络设备（eth0和tun0）部分都在内核层，其实socket是协议栈的一部分，这里分开来的目的是为了看的更直观。</p>
<a id="more"></a>
<p>tun0是一个Tun/Tap虚拟设备，从上图中可以看出它和物理设备eth0的差别，它们的一端虽然都连着协议栈，但另一端不一样，eth0的另一端是物理网络，这个物理网络可能就是一个交换机，而tun0的另一端是一个用户层的程序，协议栈发给tun0的数据包能被这个应用程序读取到，并且应用程序能直接向tun0写数据。</p>
<p>这里假设eth0配置的IP是10.32.0.11，而tun0配置的IP是192.168.3.11.</p>
<blockquote>
<p>这里列举的是一个典型的tun/tap设备的应用场景，发到192.168.3.0/24网络的数据通过程序B这个隧道，利用10.32.0.11发到远端网络的10.33.0.1，再由10.33.0.1转发给相应的设备，从而实现VPN。</p>
</blockquote>
<p>下面来看看数据包的流程：</p>
<ol>
<li>应用程序A是一个普通的程序，通过socket A发送了一个数据包，假设这个数据包的目的IP地址是192.168.3.1</li>
<li>socket将这个数据包丢给协议栈</li>
<li>协议栈根据数据包的目的IP地址，匹配本地路由规则，知道这个数据包应该由tun0出去，于是将数据包交给tun0</li>
<li>tun0收到数据包之后，发现另一端被进程B打开了，于是将数据包丢给了进程B</li>
<li>进程B收到数据包之后，做一些跟业务相关的处理，然后构造一个新的数据包，将原来的数据包嵌入在新的数据包中，最后通过socket B将数据包转发出去，这时候新数据包的源地址变成了eth0的地址，而目的IP地址变成了一个其它的地址，比如是10.33.0.1.</li>
<li>socket B将数据包丢给协议栈</li>
<li>协议栈根据本地路由，发现这个数据包应该要通过eth0发送出去，于是将数据包交给eth0</li>
<li>eth0通过物理网络将数据包发送出去</li>
</ol>
<p>10.33.0.1收到数据包之后，会打开数据包，读取里面的原始数据包，并转发给本地的192.168.3.1，然后等收到192.168.3.1的应答后，再构造新的应答包，并将原始应答包封装在里面，再由原路径返回给应用程序B，应用程序B取出里面的原始应答包，最后返回给应用程序A</p>
<blockquote>
<p>这里不讨论Tun/Tap设备tun0是怎么和用户层的进程B进行通信的，对于Linux内核来说，有很多种办法来让内核空间和用户空间的进程交换数据。</p>
</blockquote>
<p>从上面的流程中可以看出，数据包选择走哪个网络设备完全由路由表控制，所以如果我们想让某些网络流量走应用程序B的转发流程，就需要配置路由表让这部分数据走tun0。</p>
<h2 id="坑"><a href="#坑" class="headerlink" title="坑"></a>坑</h2><p>根据<a href="https://nicelee.top/blog/2019/02/14/java-android-vpnservice/" target="_blank" rel="noopener">Android VpnService初探</a></p>
<ul>
<li>什么IP包会往虚拟网卡发？或者说，虚拟网卡出入的IP报文怎么才算有效的？<ul>
<li>只有本地到外地，或者外地到本地的报文，才会途径虚拟网卡。</li>
<li>比如说， 本地6666端口，往本地9999端口发送了一个UDP包，其对应的IP报文不会经过虚拟网卡，不要指望读<strong>ParcelFileDescriptor</strong>实例能够得到这份IP报文。</li>
<li>比如说， 本地6666端口，往外地<code>8.8.8.8:53</code>发送了一个UDP包。虚拟网卡收到后，将其目的地改为指向本地<strong>UDPServer</strong>，<code>6.6.6.6:6666</code>，重新写入虚拟网卡。<br>但这时本地<strong>UDPServer</strong>并不会收到这个报文，只有将这个IP报文的源地址更改一下，例如由本地ip改为<strong>8.8.8.8</strong>(原目的地址)，这个报文才会被本地<strong>UDPServer</strong>收到。</li>
</ul>
</li>
<li>关于DNS报文<ul>
<li>似乎如果不在Builder生成时指定DNS服务器，手机本身另有一套机制，使得系统默认的DNS查询不会经过虚拟网卡。如果有需要，不妨再加一条：<br><code>builder.addDnsServer(&quot;114.114.114.114&quot;)</code></li>
</ul>
</li>
</ul>
<p>这个讨论也很有信息量：<a href="https://www.v2ex.com/t/589264" target="_blank" rel="noopener">VpnService 能否原样将三层的 IP 报文发出去？</a></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="http://arloor.com/posts/other/android-vpnservice-and-vpn-dev/" target="_blank" rel="noopener">安卓Vpn开发思路</a></li>
<li><a href="https://blog.csdn.net/jsqfengbao/article/details/52462125" target="_blank" rel="noopener">使用Android系统自带的VpnService截取流量</a></li>
<li><a href="https://segmentfault.com/a/1190000009249039" target="_blank" rel="noopener">Linux虚拟网络设备之tun/tap</a></li>
<li><a href="https://www.thegeekstuff.com/2014/06/android-vpn-service/?utm_source=tuicool&amp;utm_medium=referral" target="_blank" rel="noopener">Android VPN Service Explained with Packet Bypass Example Program</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      
        <div id="donation_div"></div>

<script src="../../../../js/vdonate.js"></script>
<script>
var a = new Donate({
  title: '如果觉得我的文章对您有用，请随意打赏。您的支持将鼓励我继续创作!', // 可选参数，打赏标题
  btnText: '打赏支持', // 可选参数，打赏按钮文字
  el: document.getElementById('donation_div'),
  wechatImage: 'https://raw.githubusercontent.com/iTimeTraveler/iTimeTraveler.github.io/site/source/about/donate/images/WeChanQR.png',
  alipayImage: 'https://raw.githubusercontent.com/iTimeTraveler/iTimeTraveler.github.io/site/source/about/donate/images/AliPayQR.jpg'
});
</script>
      
      
      <div>
        <ul class="post-copyright">
          <li class="post-copyright-author">
          <strong>本文作者:  </strong>Mr.Seven</a>
          </li>
          <li class="post-copyright-link">
          <strong>本文链接:  </strong>
          <a href="/2019/07/25/【Android】使用VPN实现抓包/" target="_blank" title="【Android】 使用VPN实现抓包">https://itimetraveler.github.io/2019/07/25/【Android】使用VPN实现抓包/</a>
          </li>
          <li class="post-copyright-license">
            <strong>版权声明:   </strong>
            本博客所有文章除特别声明外，均采用 <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a>
            许可协议。转载请注明出处
          </li>
         
        </ul>
<div>

      
      
        
	<div id="comment">
		<!-- 来必力City版安装代码 -->
		<div id="lv-container" data-id="city" data-uid="MTAyMC8yOTQ4MS82MDQ5">
		<script type="text/javascript">
		   (function(d, s) {
		       var j, e = d.getElementsByTagName(s)[0];

		       if (typeof LivereTower === 'function') { return; }

		       j = d.createElement(s);
		       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
		       j.async = true;

		       e.parentNode.insertBefore(j, e);
		   })(document, 'script');
		</script>
		<noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
		</div>
		<!-- City版安装代码已完成 -->
	</div>



      
      
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../../../tags/Android/">Android</a></li></ul>

      

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../移动端接入Cronet网络库实践/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          移动端(Android、iOS)接入Cronet实践
        
      </div>
    </a>
  
  
    <a href="../../../06/07/Android ADB原理探究/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">【Android】ADB工具原理探究</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="toc-sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#VPN抓包"><span class="nav-number">1.</span> <span class="nav-text">VPN抓包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VpnService"><span class="nav-number">2.</span> <span class="nav-text">VpnService</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#源码分析"><span class="nav-number">3.</span> <span class="nav-text">源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#VpnService-establish"><span class="nav-number">3.1.</span> <span class="nav-text">VpnService#establish()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ConnectivityService-establishVpn"><span class="nav-number">3.2.</span> <span class="nav-text">ConnectivityService#establishVpn()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Vpn-establish"><span class="nav-number">3.3.</span> <span class="nav-text">Vpn#establish()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#jniCreate"><span class="nav-number">3.4.</span> <span class="nav-text">jniCreate()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TUN-TAP是什么"><span class="nav-number">4.</span> <span class="nav-text">TUN/TAP是什么</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#字符驱动-内核空间和用户空间的数据传输"><span class="nav-number">4.1.</span> <span class="nav-text">字符驱动 - 内核空间和用户空间的数据传输</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#网卡驱动-数据包在-TCP-IP-协议栈的传输"><span class="nav-number">4.2.</span> <span class="nav-text">网卡驱动 - 数据包在 TCP/IP 协议栈的传输</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#坑"><span class="nav-number">5.</span> <span class="nav-text">坑</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资料"><span class="nav-number">6.</span> <span class="nav-text">参考资料</span></a></li></ol>
    
    </div>
  </aside>

</section>
        
      </div>
      
      <footer id="footer">
  

  <div class="container">
      	<div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2013 - 2019 iTimeTraveler All Rights Reserved.</p>
	      
	      
    		<p class="busuanzi_uv">
				访客数 : <span id="busuanzi_value_site_uv"></span> |  
				访问量 : <span id="busuanzi_value_site_pv"></span>
		    </p>
  		   
		</div>

		
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="../../../../index.html" class="mobile-nav-link">Home</a>
  
    <a href="../../../../archives" class="mobile-nav-link">Archives</a>
  
    <a href="../../../../categories" class="mobile-nav-link">Categories</a>
  
    <a href="../../../../tags" class="mobile-nav-link">Tags</a>
  
    <a href="../../../../funnysite" class="mobile-nav-link">酷站</a>
  
    <a href="../../../../collection" class="mobile-nav-link">收藏</a>
  
    <a href="../../../../about" class="mobile-nav-link">About</a>
  
    <a href="../../../../mybooks" class="mobile-nav-link">🎁</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="../../../../fancybox/jquery.fancybox.css">
  <script src="../../../../fancybox/jquery.fancybox.pack.js"></script>


<script src="../../../../js/scripts.js"></script>




  <script src="../../../../js/dialog.js"></script>








	<div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">设置</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              正文字号大小
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            您已调整页面字体大小
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              夜间护眼模式
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            夜间模式已经开启，再次单击按钮即可关闭 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;关 于&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            iTimeTraveler
          </div>
          <div class="panel-body">
            Copyright © 2019 Mr.Seven All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
      </div>
    </div>
  </div>
</div>
  
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  
    <a id="menu-switch"><i class="fa fa-bars fa-lg"></i></a>
  
</body>
</html>